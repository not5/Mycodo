{% extends "layout.html" %}
{% set active_page = "dashboard" %}
{% set help_page = ["dashboard", dict_translation['dashboard']['title']] %}

{% block title %} - {% for each_dash in dashboards if each_dash['dashboard_id'] == dashboard_id %}{{each_dash['name']}}{% endfor %} {{dict_translation['dashboard']['title']}}{% endblock %}

{% block head %}

  <script type="text/javascript" src="/static/js/highstock.js"></script>
  <script type="text/javascript" src="/static/js/highcharts-more.js"></script>

  <script type="text/javascript" src="/static/js/modules/data.js"></script>
  <script type="text/javascript" src="/static/js/modules/exporting.js"></script>
  <script type="text/javascript" src="/static/js/modules/export-data.js"></script>
  <script type="text/javascript" src="/static/js/modules/offline-exporting.js"></script>

  {# Graph popup effect#}
  <script type="text/javascript" src="/static/js/modules/highslide-full.js"></script>
  <script type="text/javascript" src="/static/js/modules/highslide.config.js"></script>
  <link href="/static/css/highslide.css" rel="stylesheet">

  <script type="text/javascript" src="/static/js/modules/solid-gauge.js"></script>

  <script type="text/javascript" src="/static/js/multiselect.min.js"></script>

  {% if current_user.theme in dark_themes %}
    <script type="text/javascript" src="/static/js/dark-unica.js"></script>
  {% endif %}

  <link href="/static/css/toastr.min.css" rel="stylesheet"/>
  <script type="text/javascript" src="/static/js/toastr.min.js"></script>

  <!-- gridstack.js -->
  <script src="/static/js/jquery.ui.touch-punch.min.js"></script>
  <link rel="stylesheet" href="/static/css/gridstack.min.css" />
  <link rel="stylesheet" href="/static/css/gridstack-custom.css" />
  <script src="/static/js/gridstack.all.js"></script>


{% endblock %}

{% block body %}
  <!-- Route: /dashboard -->
  <div class="container">
  {% include 'flash_messages.html' %}
  </div>

  <div class="container-fluid">

    <div class="grid-stack">

    {%- for each_widget in table_widget.query.filter(table_widget.dashboard_id == dashboard_id).all() -%}
      {%- set chart_number = loop.index -%}

      <div class="grid-stack-item"
         data-custom-chart-number="{{chart_number}}"
         data-custom-id="{{each_widget.unique_id}}"
         data-name="{{each_widget.name}}"
         data-gs-x="{{each_widget.position_x}}"
         data-gs-y="{{each_widget.position_y}}"
         data-gs-width="{{each_widget.width}}"
         data-gs-height="{{each_widget.height}}">

        <div class="grid-stack-item-content" style="display: flex; flex-flow: column; height: 100%; padding: 0.2em; border: 1px solid #ddd; border-radius: 5px">

        {% for id, axes in y_axes.items() if id == each_widget.unique_id and
                                             each_widget.graph_type in ['graph', 'gauge_angular', 'gauge_solid'] %}
          <!--Dashboard {{each_widget.unique_id}} y-axes: {{axes|safe}}-->
        {% endfor %}

        {% if each_widget.graph_type == 'spacer' %}
          {% include 'pages/dashboard_options/mod_spacer.html' %}
        {% elif each_widget.graph_type == 'graph' %}
          {% include 'pages/dashboard_options/mod_graph.html' %}
        {% elif each_widget.graph_type in ['gauge_angular', 'gauge_solid'] %}
          {% include 'pages/dashboard_options/mod_gauge.html' %}
        {% elif each_widget.graph_type == 'indicator' %}
          {% include 'pages/dashboard_options/mod_indicator.html' %}
        {% elif each_widget.graph_type == 'measurement' %}
          {% include 'pages/dashboard_options/mod_measurement.html' %}
        {% elif each_widget.graph_type == 'output' %}
          {% include 'pages/dashboard_options/mod_output.html' %}
        {% elif each_widget.graph_type == 'output_pwm_slider' %}
          {% include 'pages/dashboard_options/mod_output_pwm_slider.html' %}
        {% elif each_widget.graph_type == 'pid_control' %}
          {% include 'pages/dashboard_options/mod_pid_control.html' %}
        {% elif each_widget.graph_type == 'camera' %}
          {% include 'pages/dashboard_options/mod_camera.html' %}
        {% endif %}

        </div>
      </div>

    {%- endfor -%}

    </div>
    <hr/>

  </div>

  <div style="clear: both"></div>

  <div class="container-fluid" style="padding-bottom: 1em">

    <div class="form-inline" style="padding-bottom: 1em;">
      <div class="form-group">
        {{form_base.widget_type(class_='selectpicker', **{'data-style': 'btn btn-sm btn-primary'})}}
      </div>
    </div>

    <div class="add_dashboard_object" style="display: none" id="spacer">
      {% include 'pages/dashboard_options/add_spacer.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="graph">
      {% include 'pages/dashboard_options/add_graph.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="gauge">
      {% include 'pages/dashboard_options/add_gauge.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="indicator">
      {% include 'pages/dashboard_options/add_indicator.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="measurement">
      {% include 'pages/dashboard_options/add_measurement.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="output">
      {% include 'pages/dashboard_options/add_output.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="output_pwm_slider">
      {% include 'pages/dashboard_options/add_output_pwm_slider.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="pid_control">
      {% include 'pages/dashboard_options/add_pid_control.html' %}
    </div>
    <div class="add_dashboard_object" style="display: none" id="camera">
      {% include 'pages/dashboard_options/add_camera.html' %}
    </div>

  </div>

<script type="text/javascript">

// Dashboard Grid

var options = {
  cellHeight: {{misc.grid_cell_height}},
  column: 20,
  resizable: {
    handles: 'se, sw'
  },
  draggable: {
    handle: '.panel-heading'
  },
  alwaysShowResizeHandle: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
  float: true
};
var grid = $('.grid-stack').gridstack(options);

grid.on('change', function (event, items) {
  if ($(items)) {
    var res = $('.grid-stack > .grid-stack-item:visible').map(function (i, el) {
      el = $(el);
      node = el.data('_gridstack_node');
      return {
        name: el.attr('data-name'),
        widget_id: el.attr('data-custom-id'),
        position_x: node.x,
        position_y: node.y,
        width: node.width,
        height: node.height
      };
    });
    $.ajax({
      url: "/save_dashboard_layout",
      type: "POST",
      data: JSON.stringify(res.toArray()),
      contentType: "application/json; charset=utf-8",
      success: function (dat) {
      }
    });
  }
});

jQuery(document).ready(function($) {
  $('#multiselect').multiselect({
    sort: false,
    keepRenderingSort: true
  });
});


// Output PWM Slider Widget

function showVal(chart, duty_cycle){
  document.getElementById("range_val_" + chart).innerHTML = duty_cycle;
}

function sendVal(chart, output_id, duty_cycle){
  document.getElementById("range_val_" + chart).innerHTML = duty_cycle;
  var cmd_send = output_id + '/on/pwm/' + duty_cycle;
  modOutput(cmd_send);
}


// Add Dashboard Widget content selector

$('#widget_type').on('change', function () {
  var x = document.getElementsByClassName("add_dashboard_object");  // Find the widgets
  for(var i = 0; i < x.length; i++){
    x[i].style.display = "none";    // Change the content
  }
  if (this.value !== '') {
    document.getElementById(this.value).style.display = "block";
    document.getElementById(this.value).scrollIntoView();
  }
});


// Turn Output on or off

function modOutput(btn_val) {
  $.ajax({
      type: 'GET',
      url: '/output_mod/' + btn_val,
    {% if not misc.hide_alert_success %}
      success: function(data) {
        if (data.startsWith("SUCCESS")) {
          toastr['success']("Output: " + data);
        }
        else {
          toastr['error']("Output: " + data);
        }
      },
    {% endif %}
    {% if not misc.hide_alert_warning %}
      error: function(data) {
          toastr['error']("Output " + btn_val.split("/")[0] + ": " + data);
      }
    {% endif %}
  });
}

$(document).ready(function() {
  $('.turn_on').click(function() {
    var btn_val = this.name;
    var send_cmd = btn_val.substring(btn_val.indexOf('/')+1);
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to turn output On');
    {% endif %}
    modOutput(send_cmd);
  });
  $('.turn_off').click(function() {
    var btn_val = this.name;
    var send_cmd = btn_val.substring(btn_val.indexOf('/') + 1);
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to turn output Off');
    {% endif %}
    modOutput(send_cmd);
  });
  $('.output_on_amt').click(function() {
    var btn_val = this.name;
    var chart = btn_val.split('/')[0];
    var id = btn_val.split('/')[1];
    var on_amt = $('#sec_on_amt_' + chart + '_' + id).val();
    var send_cmd = btn_val.substring(btn_val.indexOf('/') + 1);
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to turn output On for ' + on_amt);
    {% endif %}
    modOutput(send_cmd + on_amt);
  });
  $('.duty_cycle_on_amt').click(function() {
    var btn_val = this.name;
    var chart = btn_val.split('/')[0];
    var id = btn_val.split('/')[1];
    var dc = $('#duty_cycle_on_amt_' + chart + '_' + id).val();
    var send_cmd = btn_val.substring(btn_val.indexOf('/') + 1);
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to turn output On with a duty cycle of ' + dc + '%');
    {% endif %}
    modOutput(send_cmd + dc);
  });
});


// Modify PID Controller

function modPID(btn_val) {
  $.ajax({
      type: 'GET',
      url: '/pid_mod_unique_id/' + btn_val,
    {% if not misc.hide_alert_success %}
      success: function(data) {
          toastr['success'](data);
      },
    {% endif %}
    {% if not misc.hide_alert_warning %}
      error: function(data) {
        toastr['error'](btn_val.split("/")[0] + ": " + data);
      }
    {% endif %}
  });
}

$(document).ready(function() {
  $('.activate_pid').click(function() {
    var btn_val = this.name;
    var id = btn_val.split('/')[0];
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to Activate PID');
    {% endif %}
    modPID(btn_val);
  });
  $('.deactivate_pid').click(function() {
    var btn_val = this.name;
    var id = btn_val.split('/')[0];
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to Deactivate PID');
    {% endif %}
    modPID(btn_val);
  });
  $('.pause_pid').click(function() {
    var btn_val = this.name;
    var id = btn_val.split('/')[0];
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to Pause PID');
    {% endif %}
    modPID(btn_val);
  });
  $('.hold_pid').click(function() {
    var btn_val = this.name;
    var id = btn_val.split('/')[0];
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to Hold PID');
    {% endif %}
    modPID(btn_val);
  });
  $('.resume_pid').click(function() {
    var btn_val = this.name;
    var id = btn_val.split('/')[0];
    {% if not misc.hide_alert_info %}
    toastr['info']('Command sent to Resume PID');
    {% endif %}
    modPID(btn_val);
  });
  $('.set_setpoint').click(function() {
    var btn_val = this.name;
    var id = btn_val.split('/')[0];
    var setpoint = $('#setpoint_pid_' + id).val();
    if(setpoint) {
      {% if not misc.hide_alert_info %}
      toastr['info']('Command sent to set PID setpoint');
      {% endif %}
      modPID(btn_val + setpoint);
    }
  });
});


// Graph Widget

Highcharts.setOptions({
  global: {
    useUTC: false
  },
  lang: {
    thousandsSep: ','
  }
});

// Store the time (epoch) of the last data point received, for every condition of every graph
var last_output_time_mil = {};

$(document).ready(function() {
  var chart = [];
  var note_timestmaps = [];

  function getGPIOState(chart_number, unique_id) {
    var url = '/outputstate_unique_id/' + unique_id;
    $.getJSON(url,
      function(state, responseText, jqXHR) {
        if (jqXHR.status !== 204) {
          if (state !== null) {
            document.getElementById("container-output-" + chart_number).className = "active-background";
            if (state !== 'off') {
              if (state === 'on') {
                document.getElementById("text-output-state-" + chart_number).innerHTML = '{{_('Active')}}';
              } else {
                document.getElementById("text-output-state-" + chart_number).innerHTML = '{{_('Active')}}, ' + state.toFixed(1) + '%';
              }
            }
            else {
              document.getElementById("container-output-" + chart_number).className = "inactive-background";
              document.getElementById("text-output-state-" + chart_number).innerHTML = '{{_('Inactive')}}';
            }
          }
        }
        else {
          document.getElementById("container-output-" + chart_number).className = "pause-background";
          document.getElementById("text-output-state-" + chart_number).innerHTML = '{{_('No Connection')}}';
        }
      }
    );
  }

  function repeatGPIOState(chart_number, unique_id, refresh_duration) {
    setInterval(function () {
      getGPIOState(chart_number, unique_id);
    }, refresh_duration * 1000);  // Refresh duration in milliseconds
  }

  // Retrieve initial graph data set from the past (duration set by user)
  function getPastData(chart_number, series, unique_id, measure_type, measurement_id, past_seconds) {
    var url = '/past/' + unique_id + '/' + measure_type + '/' + measurement_id + '/' + past_seconds;
    var update_id = chart_number + "-" + series + "-" + unique_id + "-" + measure_type + '-' + measurement_id;
    $.getJSON(url,
      function(data, responseText, jqXHR) {
        if (jqXHR.status !== 204) {
          var past_data = [];
          for (i = 0; i < data.length; i++) {
            // Push the received data to the graph
            var new_date = new Date(data[i][0]);
            var new_time = new_date.getTime();

            if (measure_type === 'tag') {
              if (!note_timestmaps.includes(new_time)) {
                past_data.push({
                  x: new_time,
                  title: data[i][1],
                  text: data[i][2].replace(/(?:\r\n|\r|\n)/g, '<br>').replace(/  /g, '░░')
                });
                note_timestmaps.push(new_time);
              }
            }
            else {
              past_data.push([new_time, data[i][1]]);
            }

            // Store the epoch time of the last data point received
            if (i === data.length - 1) {
              if (measure_type === 'tag') {
                last_output_time_mil[update_id] = new_time + 3000;
              }
              else {
                last_output_time_mil[update_id] = new_time;
              }
            }
          }
          chart[chart_number].series[series].isDirty = true;
          chart[chart_number].xAxis[0].setExtremes(new Date().setMinutes(new Date().getMinutes() - (past_seconds / 60)), new Date().getTime());
          chart[chart_number].series[series].setData(past_data, true, false);
        }
      }
    );
  }

  // Return timestamp from epoch
  function epoch_to_timestamp(epoch) {
    var date = new Date(parseFloat(epoch));
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hours = date.getHours();
    var minutes = "0" + date.getMinutes();
    var seconds = "0" + date.getSeconds();
    return month + "/" + day + " " + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
  }

  // Retrieve the latest/last measurement for gauges/outputs
  function getLastData(chart_number, dash_type, unique_id, measure_type, measurement_id, max_measure_age_sec, decimal_places, extra) {
    if (decimal_places === null) {
      decimal_places = 1;
    }
    if (dash_type === "indicator" && measure_type === "output") {
      var url = '/outputstate_unique_id/' + unique_id;
      $.ajax(url, {
        success: function (data, responseText, jqXHR) {
          if (jqXHR.status !== 204) {
            if (data !== null) {
              document.getElementById('timestamp-' + chart_number).innerHTML = '';
              if (data !== 'off') {
                document.getElementById('value-' + chart_number).title = "{{_('On')}}";
              } else {
                document.getElementById('value-' + chart_number).title = "{{_('Off')}}";
              }
              if ((data !== 'off' && !extra) || (data === 'off' && extra)) {
                document.getElementById('value-' + chart_number).src = '/static/img/button-green.png';
              }
              else {
                document.getElementById('value-' + chart_number).src = '/static/img/button-red.png';
              }
            }
          } else {
            document.getElementById('value-' + chart_number).src = '/static/img/button-yellow.png';
            document.getElementById('timestamp-' + chart_number).innerHTML = '{{_('Error')}}';
          }
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          document.getElementById('value-' + chart_number).src = '';
          document.getElementById('value-' + chart_number).innerHTML = 'NO DATA';
          document.getElementById('timestamp-' + chart_number).innerHTML = '{{_('Error')}}';
        }
      });
    } else {
      var url = '/last/' + unique_id + '/' + measure_type + '/' + measurement_id + '/' + max_measure_age_sec.toString();
      $.ajax(url, {
        success: function(data, responseText, jqXHR) {
          if (jqXHR.status === 204) {
            if (dash_type === "gauge") {
              var null_point = chart[chart_number].series[0].points[0];
              null_point.update(null);
            } else if (['indicator', 'measurement', 'output', 'pid_control'].indexOf(dash_type) >= 0) {
              document.getElementById('value-' + chart_number).innerHTML = 'NO DATA';
              document.getElementById('timestamp-' + chart_number).innerHTML = 'MAX AGE EXCEEDED';
            }
          }
          else {
            var formattedTime = epoch_to_timestamp(data[0]);
            var measurement = data[1];

            if (dash_type === "gauge") {
              var new_point = chart[chart_number].series[0].points[0];
              new_point.update(measurement);
            } else if (dash_type === "indicator") {
              if ((measurement && !extra) || (!measurement && extra)) {
                document.getElementById('value-' + chart_number).src = '/static/img/button-green.png';
              } else {
                document.getElementById('value-' + chart_number).src = '/static/img/button-red.png';
              }
              document.getElementById('value-' + chart_number).title = "{{_('Value')}}: " + measurement;
            } else {
              document.getElementById('value-' + chart_number).innerHTML = measurement.toFixed(decimal_places);

              var range_exists = document.getElementById("range_" + chart_number);
              if (range_exists != null) {  // Update range slider value
                document.getElementById("range_" + chart_number).value = measurement.toFixed(0);
                document.getElementById("range_val_" + chart_number).innerHTML = measurement.toFixed(0);
              }
            }
            document.getElementById('timestamp-' + chart_number).innerHTML = formattedTime;
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          if (dash_type === "gauge") {
            var point = chart[chart_number].series[0].points[0];
            point.update(null);
          } else if (['indicator', 'measurement', 'output', 'pid_control'].indexOf(dash_type) >= 0) {
            document.getElementById('value-' + chart_number).innerHTML = 'NO DATA';
            document.getElementById('timestamp-' + chart_number).innerHTML = '{{_('Error')}}';
          }
        }
      });
    }
  }

  // Repeat function for getLastData()
  function repeatLastData(chart_number, dash_type, dev_id, measure_type, measurement_id, period_sec, max_measure_age_sec, decimal_places, extra) {
    setInterval(function () {
      getLastData(chart_number, dash_type, dev_id, measure_type, measurement_id, max_measure_age_sec, decimal_places, extra)
    }, period_sec * 1000);
  }

  function print_pid_value(data, name, chart_number, decimal_places, units) {
    if (name === 'setpoint' && data['setpoint_band']) {
      data[name][1] = data['setpoint_band']
    }

    if (data[name][0] && document.getElementById(name + '-timestamp-' + chart_number)) {
      document.getElementById(name + '-timestamp-' + chart_number).innerHTML = epoch_to_timestamp(data[name][0]);
    } else if (document.getElementById(name + '-timestamp-' + chart_number)) {
      document.getElementById(name + '-timestamp-' + chart_number).innerHTML = 'MAX AGE EXCEEDED';
    }
    if (data[name][1] && document.getElementById(name + '-' + chart_number)) {
      var value = parseFloat(data[name][1]).toFixed(decimal_places);
      document.getElementById(name + '-' + chart_number).innerHTML = value + units;
    } else if (document.getElementById(name + '-' + chart_number)) {
      document.getElementById(name + '-' + chart_number).innerHTML = 'NULL';
    }
  }

  function print_pid_error(chart_number) {
    document.getElementById('container-pid-' + chart_number).className = "pause-background";
    document.getElementById('setpoint-' + chart_number).innerHTML = 'ERR';
    document.getElementById('setpoint-timestamp-' + chart_number).innerHTML = 'ERR';
    document.getElementById('pid_p_value-' + chart_number).innerHTML = 'ERR';
    document.getElementById('pid_i_value-' + chart_number).innerHTML = 'ERR';
    document.getElementById('pid_d_value-' + chart_number).innerHTML = 'ERR';
    document.getElementById('pid_pid_value-' + chart_number).innerHTML = 'ERR';
    document.getElementById('duration_time-' + chart_number).innerHTML = 'ERR';
    document.getElementById('actual-' + chart_number).innerHTML = 'ERR';
    document.getElementById('actual-timestamp-' + chart_number).innerHTML = 'ERR';
  }

  // Retrieve the latest/last measurement for gauges/outputs
  function getLastDataPID(chart_number, dev_id, max_measure_age_sec, decimal_places, units) {
    var url = '/last_pid/' + dev_id + '/' + max_measure_age_sec.toString();
    $.ajax(url, {
      success: function(data, responseText, jqXHR) {
        if (jqXHR.status === 204) {
          print_pid_error(chart_number);
        }
        else {
          if (data['activated']) {
            if (data['paused']) {
              document.getElementById('text-pid-state-' + chart_number).innerHTML = 'Paused';
              document.getElementById('container-pid-' + chart_number).className = "pause-background";
              document.getElementById('button-activate-' + chart_number).style.display = "none";
              document.getElementById('button-deactivate-' + chart_number).style.display = "block";
              document.getElementById('button-pause-' + chart_number).style.display = "none";
              document.getElementById('button-resume-' + chart_number).style.display = "block";
              document.getElementById('button-hold-' + chart_number).style.display = "none";
              print_pid_value(data, 'setpoint', chart_number, decimal_places, ' ' + units);
              document.getElementById('setpoint-timestamp-' + chart_number).innerHTML = 'PAUSED';
              print_pid_value(data, 'actual', chart_number, decimal_places, ' ' + units);
              print_pid_value(data, 'pid_p_value', chart_number, 1, '');
              print_pid_value(data, 'pid_i_value', chart_number, 1, '');
              print_pid_value(data, 'pid_d_value', chart_number, 1, '');
              print_pid_value(data, 'pid_pid_value', chart_number, 1, '');

              {#Find which PID output is more recent, seconds on or duty cycle#}
              if (data['duration_time'][1] !== null && data['duty_cycle'][1] !== null) {
                if (data['duration_time'][0] > data['duty_cycle'][0]) {
                  document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
                  print_pid_value(data, 'duration_time', chart_number, 1, ' sec');
                } else {
                  document.getElementById('duration_time-' + chart_number).innerHTML = '';
                  print_pid_value(data, 'duty_cycle', chart_number, 1, ' %');
                }
              } else if (data['duration_time'][1] !== null) {
                document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
                print_pid_value(data, 'duration_time', chart_number, 1, ' sec');
              } else if (data['duty_cycle'][1] !== null) {
                document.getElementById('duration_time-' + chart_number).innerHTML = '';
                print_pid_value(data, 'duty_cycle', chart_number, 1, ' %');
              } else {
                document.getElementById('duration_time-' + chart_number).innerHTML = 'NULL';
                document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
              }

            } else if (data['held']) {
              document.getElementById('text-pid-state-' + chart_number).innerHTML = 'Held';
              document.getElementById('container-pid-' + chart_number).className = "pause-background";
              document.getElementById('button-activate-' + chart_number).style.display = "none";
              document.getElementById('button-deactivate-' + chart_number).style.display = "block";
              document.getElementById('button-pause-' + chart_number).style.display = "none";
              document.getElementById('button-resume-' + chart_number).style.display = "block";
              document.getElementById('button-hold-' + chart_number).style.display = "none";
              print_pid_value(data, 'setpoint', chart_number, decimal_places, ' ' + units);
              document.getElementById('setpoint-timestamp-' + chart_number).innerHTML = 'HELD';
              print_pid_value(data, 'actual', chart_number, decimal_places, ' ' + units);
              print_pid_value(data, 'pid_p_value', chart_number, 1, '');
              print_pid_value(data, 'pid_i_value', chart_number, 1, '');
              print_pid_value(data, 'pid_d_value', chart_number, 1, '');
              print_pid_value(data, 'pid_pid_value', chart_number, 1, '');

              {#Find which PID output is more recent, seconds on or duty cycle#}
              if (data['duration_time'][1] !== null && data['duty_cycle'][1] !== null) {
                if (data['duration_time'][0] > data['duty_cycle'][0]) {
                  document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
                  print_pid_value(data, 'duration_time', chart_number, 1, ' sec');
                } else {
                  document.getElementById('duration_time-' + chart_number).innerHTML = '';
                  print_pid_value(data, 'duty_cycle', chart_number, 1, ' %');
                }
              } else if (data['duration_time'][1] !== null) {
                document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
                print_pid_value(data, 'duration_time', chart_number, 1, ' sec');
              } else if (data['duty_cycle'][1] !== null) {
                document.getElementById('duration_time-' + chart_number).innerHTML = '';
                print_pid_value(data, 'duty_cycle', chart_number, 1, ' %');
              } else {
                document.getElementById('duration_time-' + chart_number).innerHTML = 'NULL';
                document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
              }
            } else {
              document.getElementById('text-pid-state-' + chart_number).innerHTML = 'Active';
              document.getElementById('container-pid-' + chart_number).className = "active-background";
              document.getElementById('button-activate-' + chart_number).style.display = "none";
              document.getElementById('button-deactivate-' + chart_number).style.display = "block";
              document.getElementById('button-pause-' + chart_number).style.display = "block";
              document.getElementById('button-resume-' + chart_number).style.display = "none";
              document.getElementById('button-hold-' + chart_number).style.display = "block";
              print_pid_value(data, 'setpoint', chart_number, decimal_places, ' ' + units);
              print_pid_value(data, 'actual', chart_number, decimal_places, ' ' + units);
              print_pid_value(data, 'pid_p_value', chart_number, 1, '');
              print_pid_value(data, 'pid_i_value', chart_number, 1, '');
              print_pid_value(data, 'pid_d_value', chart_number, 1, '');
              print_pid_value(data, 'pid_pid_value', chart_number, 1, '');

              {#Find which PID output is more recent, seconds on or duty cycle#}
              if (data['duration_time'][1] !== null && data['duty_cycle'][1] !== null) {
                if (data['duration_time'][0] > data['duty_cycle'][0]) {
                  document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
                  print_pid_value(data, 'duration_time', chart_number, 1, ' sec');
                } else {
                  document.getElementById('duration_time-' + chart_number).innerHTML = '';
                  print_pid_value(data, 'duty_cycle', chart_number, 1, ' %');
                }
              } else if (data['duration_time'][1] !== null) {
                document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
                print_pid_value(data, 'duration_time', chart_number, 1, ' sec');
              } else if (data['duty_cycle'][1] !== null) {
                document.getElementById('duration_time-' + chart_number).innerHTML = '';
                print_pid_value(data, 'duty_cycle', chart_number, 1, ' %');
              } else {
                document.getElementById('duration_time-' + chart_number).innerHTML = 'NULL';
                document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
              }
            }
          } else {
            document.getElementById('text-pid-state-' + chart_number).innerHTML = 'Inactive';
            document.getElementById('container-pid-' + chart_number).className = "inactive-background";
            document.getElementById('button-activate-' + chart_number).style.display = "block";
            document.getElementById('button-deactivate-' + chart_number).style.display = "none";
            document.getElementById('button-pause-' + chart_number).style.display = "none";
            document.getElementById('button-resume-' + chart_number).style.display = "none";
            document.getElementById('button-hold-' + chart_number).style.display = "none";
            document.getElementById('setpoint-' + chart_number).innerHTML = 'NONE';
            document.getElementById('setpoint-timestamp-' + chart_number).innerHTML = 'INACTIVE';
            document.getElementById('pid_p_value-' + chart_number).innerHTML = '0';
            document.getElementById('pid_i_value-' + chart_number).innerHTML = '0';
            document.getElementById('pid_d_value-' + chart_number).innerHTML = '0';
            document.getElementById('pid_pid_value-' + chart_number).innerHTML = '0';
            document.getElementById('duration_time-' + chart_number).innerHTML = '0';
            document.getElementById('duty_cycle-' + chart_number).innerHTML = '';
            print_pid_value(data, 'actual', chart_number, decimal_places, ' ' + units);
          }
        }
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        print_pid_error(chart_number);
      }
    });
  }

  // Repeat function for getLastData()
  function repeatLastDataPID(chart_number, dev_id, period_sec, max_measure_age_sec, decimal_places, units) {
    setInterval(function () {
      getLastDataPID(chart_number, dev_id, max_measure_age_sec, decimal_places, units)
    }, period_sec * 1000);
  }

  // Redraw a particular chart
  function redrawGraph(chart_number, refresh_seconds, xaxis_duration_min, xaxis_reset) {
    chart[chart_number].redraw();
    if (xaxis_reset) {
      // Ensure Reset Zoom button resets to the proper start and end times
      chart[chart_number].xAxis[0].update({min: new Date().setMinutes(new Date().getMinutes() - (1 * (xaxis_duration_min)))}, false);
      chart[chart_number].xAxis[0].update({max: new Date().getTime()}, false);
      // Update the new data time frame and redraw the chart
      chart[chart_number].xAxis[0].setExtremes(new Date().setMinutes(new Date().getMinutes() - (1 * (xaxis_duration_min))), new Date().getTime(), true);
      chart[chart_number].xAxis[0].isDirty = true;
    }
  }

  // Retrieve chart data for the period since the last data acquisition (refresh period set by user)
  function retrieveLiveData(chart_number,
                            series,
                            unique_id,
                            measure_type,
                            measurement_id,
                            xaxis_duration_min,
                            xaxis_reset,
                            refresh_seconds,
                            graph_shift) {
    // Build the URL
    // Instruct only to return data since the time of the last received data point
    var url = '';
    var update_id = chart_number + "-" + series + "-" + unique_id + "-" + measure_type + '-' + measurement_id;
    if (update_id in last_output_time_mil) {
      var epoch_mil = (new Date).getTime();
      var past_seconds = Math.floor((epoch_mil - last_output_time_mil[update_id]) / 1000);
      url = '/past/' + unique_id + '/' + measure_type + '/' + measurement_id + '/' + past_seconds;
    } else {
      url = '/past/' + unique_id + '/' + measure_type + '/' + measurement_id + '/' + refresh_seconds;
    }
    $.getJSON(url,
      function(data, responseText, jqXHR) {
        if (jqXHR.status !== 204) {
          for (i = 0; i < data.length; i++) {
            var new_date = new Date(data[i][0]);
            var new_time = new_date.getTime();

            if (measure_type === 'tag') {
              if (!note_timestmaps.includes(new_time)) {
                chart[chart_number].series[series].addPoint({
                  x: new_time,
                  title: data[i][1],
                  text: data[i][2]
                }, false, graph_shift);
                note_timestmaps.push(new_time);
              }
            }
            else {
              chart[chart_number].series[series].addPoint([new_time, data[i][1]], false, graph_shift);
            }
          }
          if (measure_type === 'tag') {
            last_output_time_mil[update_id] = new_time + 3000;
          }
          else {
            last_output_time_mil[update_id] = new_time;
          }
          redrawGraph(chart_number, refresh_seconds, xaxis_duration_min, xaxis_reset);
        }
      }
    );
  }

  // Repeat function for retrieveLiveData()
  function getLiveData(chart_number,
                       series,
                       unique_id,
                       measure_type,
                       measurement_id,
                       xaxis_duration_min,
                       xaxis_reset,
                       refresh_seconds,
                       graph_shift) {
    setInterval(function () {
      retrieveLiveData(chart_number,
                       series,
                       unique_id,
                       measure_type,
                       measurement_id,
                       xaxis_duration_min,
                       xaxis_reset,
                       refresh_seconds,
                       graph_shift);
    }, refresh_seconds * 1000);
  }

  // Capture image and update the image
  function get_image_cam(dashboard_id, camera_unique_id, image_type, max_age) {
    var url = '';
    var image_type_str = '';
    if (image_type === 'tmp_img') {
      url = '/camera_acquire_image/tmp/' + camera_unique_id + '/' + max_age;
      image_type_str = 'still'
    } else if (image_type === 'new_image') {
      url = '/camera_acquire_image/new/' + camera_unique_id + '/' + max_age;
      image_type_str = 'still'
    } else if (image_type === 'timelapse') {
      url = '/camera_latest_timelapse/' + camera_unique_id + '/' + max_age;
      image_type_str = 'timelapse'
    }
    $.ajax(url, {
      success: function(data, responseText, jqXHR) {
        if (jqXHR.status === 204) {
          document.getElementById(dashboard_id + "-image-src").src = "/static/img/image_error.png";
          document.getElementById(dashboard_id + "-image-href").href = "/static/img/image_error.png";
        }
        else {
          var timestamp_str = '';
          if (image_type_str === 'still') {
            timestamp_str = 'Still: '
          } else if (image_type_str === 'timelapse') {
            timestamp_str = 'Timelapse: '
          }
          var filename = data[0];
          if (filename === 'max_age_exceeded') {
            // The image timestamp is older than the maximum allowable age
            document.getElementById(dashboard_id + "-image-src").src = "/static/img/image_max_age.png";
            document.getElementById(dashboard_id + "-image-href").href = "/static/img/image_max_age.png";
            document.getElementById(dashboard_id + "-timestamp").innerHTML = timestamp_str + "Max Age Exceeded";
          } else if (filename === 'file_not_found') {
            // No image was found in the directory
            document.getElementById(dashboard_id + "-image-src").src = "/static/img/image_error.png";
            document.getElementById(dashboard_id + "-image-href").href = "/static/img/image_error.png";
            document.getElementById(dashboard_id + "-timestamp").innerHTML = timestamp_str + "File Not Found";
          } else {
            // The image is available and younger than the max age
            var timestamp = data[1];
            var image_no_cache_timestamp = Date.now();
            document.getElementById(dashboard_id + "-image-src").src = "/camera/" + camera_unique_id + "/" + image_type_str + "/" + filename + "?" + image_no_cache_timestamp;
            document.getElementById(dashboard_id + "-image-href").href = "/camera/" + camera_unique_id + "/" + image_type_str + "/" + filename + "?" + image_no_cache_timestamp;
            document.getElementById(dashboard_id + "-timestamp").innerHTML = timestamp_str + timestamp;
          }
        }
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        document.getElementById(dashboard_id + "-image-src").src = "/static/img/image_error.png";
        document.getElementById(dashboard_id + "-image-href").href = "/static/img/image_error.png";
        document.getElementById(dashboard_id + "-timestamp").innerHTML = "Error Getting Image";
      }
    });
  }

  // Repeat function for get_image_cam()
  function repeat_get_image_cam(dashboard_id, camera_unique_id, period_sec, image_type, max_age) {
    if (image_type === 'stream') {
      document.getElementById(dashboard_id + "-image-src").src = "/video_feed/" + camera_unique_id;
      document.getElementById(dashboard_id + "-timestamp").innerHTML = 'Live Stream';
    } else {
      get_image_cam(dashboard_id, camera_unique_id, image_type, max_age);
      setInterval(function () {
          get_image_cam(dashboard_id, camera_unique_id, image_type, max_age)
      }, period_sec * 1000);
    }
  }

  // Change opacity of all chart colors
  Highcharts.getOptions().colors = Highcharts.map(Highcharts.getOptions().colors, function (color) {
    return Highcharts.Color(color).setOpacity(0.6).get('rgba');
  });

{%- for each_widget in table_widget.query.filter(table_widget.dashboard_id == dashboard_id).all() -%}
  {%- set chart_number = loop.index -%}
  {% set graph_input_ids = each_widget.input_ids_measurements.split(';') %}

  {% if each_widget.graph_type == 'graph' %}
    {% include 'pages/dashboard_options/display_graph.html' %}
  {% elif each_widget.graph_type == 'gauge_solid' %}
    {% include 'pages/dashboard_options/display_gauge_solid.html' %}
  {% elif each_widget.graph_type == 'gauge_angular' %}
    {% include 'pages/dashboard_options/display_gauge_angular.html' %}
  {% elif each_widget.graph_type == 'indicator' %}
    {% include 'pages/dashboard_options/display_indicator.html' %}
  {% elif each_widget.graph_type == 'measurement' %}
    {% include 'pages/dashboard_options/display_measurement.html' %}
  {% elif each_widget.graph_type == 'output' %}
    {% include 'pages/dashboard_options/display_output.html' %}
  {% elif each_widget.graph_type == 'output_pwm_slider' %}
    {% include 'pages/dashboard_options/display_output_pwm_slider.html' %}
  {% elif each_widget.graph_type == 'pid_control' %}
    {% include 'pages/dashboard_options/display_pid_control.html' %}
  {% elif each_widget.graph_type == 'camera' %}
    {% include 'pages/dashboard_options/display_camera.html' %}
  {% endif %}

{%- endfor -%}

  $('.grid-stack').on('gsresizestop', function(event, elem) {
    var chart_number = $(elem).attr('data-custom-chart-number');
    chart[chart_number].reflow();
  });

});

</script>

{% endblock %}
